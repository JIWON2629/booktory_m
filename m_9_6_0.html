<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì…ì¶œê³ í˜„í™© - KSI OSP</title>
    <link rel="stylesheet" href="./css/mobile-common.css">
    <style>
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; z-index: 100; background: white; }
        .sub-header { position: relative; background: white; padding: 10px 15px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee; }
        .sub-header-title { font-size: 17px; font-weight: bold; flex: 1; }
        .btn-back { background: none; border: none; font-size: 20px; color: #333; padding: 5px; }
        .period-selector { position: relative; display: flex; gap: 8px; padding: 10px 15px; background: white; border-bottom: 1px solid #eee; overflow-x: auto; }
        .period-btn { padding: 9px 18px; border: 1px solid #ddd; background: white; border-radius: 20px; font-size: 14px; white-space: nowrap; }
        .period-btn.active { background: #1a73e8; color: white; border-color: #1a73e8; }
        .main-content { margin-top: 110px; padding-bottom: 70px; }
        .chart-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .chart-title { font-weight: bold; font-size: 15px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .bar-chart { display: flex; flex-direction: column; gap: 12px; }
        .bar-row { display: flex; align-items: center; gap: 10px; }
        .bar-label { width: 50px; font-size: 14px; color: #666; }
        .bar-container { flex: 1; height: 26px; background: #f0f0f0; border-radius: 12px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 13px; color: white; font-weight: bold; min-width: 30px; }
        .bar-fill.in { background: linear-gradient(90deg, #4caf50, #81c784); }
        .bar-fill.out { background: linear-gradient(90deg, #ff9800, #ffb74d); }
        .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .summary-item { background: white; border-radius: 12px; padding: 15px; text-align: center; }
        .summary-icon { font-size: 28px; margin-bottom: 8px; }
        .summary-value { font-size: 26px; font-weight: bold; }
        .summary-value.in { color: #4caf50; }
        .summary-value.out { color: #ff9800; }
        .summary-label { font-size: 14px; color: #888; margin-top: 4px; }
        .pie-chart { display: flex; align-items: center; gap: 20px; }
        .pie-svg { width: 120px; height: 120px; }
        .pie-legend { flex: 1; }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 14px; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
        .recent-list { max-height: 300px; overflow-y: auto; }
        .recent-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .recent-item:last-child { border-bottom: none; }
        .recent-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 12px; }
        .recent-icon.in { background: #e8f5e9; }
        .recent-icon.out { background: #fff3e0; }
        .recent-info { flex: 1; }
        .recent-title { font-weight: 500; font-size: 15px; margin-bottom: 2px; }
        .recent-detail { font-size: 13px; color: #888; }
        .recent-qty { font-weight: bold; font-size: 15px; }
        .recent-qty.in { color: #4caf50; }
        .recent-qty.out { color: #ff9800; }
        .recent-icon.adjust { background: #f3e5f5; }
        .recent-qty.adjust { color: #9c27b0; }
    </style>
</head>
<body>
    <div class="fixed-header">
        <div class="sub-header">
            <button class="btn-back" onclick="history.back()">â†</button>
            <div class="sub-header-title">ğŸ“ˆ ì…ì¶œê³ í˜„í™©</div>
        </div>
        <div class="period-selector">
            <button class="period-btn active" data-period="today" onclick="setPeriod('today')">ì˜¤ëŠ˜</button>
            <button class="period-btn" data-period="week" onclick="setPeriod('week')">ì´ë²ˆì£¼</button>
            <button class="period-btn" data-period="month" onclick="setPeriod('month')">ì´ë²ˆë‹¬</button>
            <button class="period-btn" data-period="quarter" onclick="setPeriod('quarter')">ë¶„ê¸°</button>
        </div>
    </div>
    <div class="offline-banner">ğŸ“´ ì˜¤í”„ë¼ì¸ ëª¨ë“œ</div>
    <div class="main-content">
        <div style="padding: 15px;">
            <!-- ìš”ì•½ -->
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-icon">ğŸ“¥</div>
                    <div class="summary-value in" id="totalIn">+12,500</div>
                    <div class="summary-label">ì´ ì…ê³ </div>
                </div>
                <div class="summary-item">
                    <div class="summary-icon">ğŸ“¤</div>
                    <div class="summary-value out" id="totalOut">-8,200</div>
                    <div class="summary-label">ì´ ì¶œê³ </div>
                </div>
            </div>
            
            <!-- ì¼ë³„ ì¶”ì´ -->
            <div class="chart-card">
                <div class="chart-title">ğŸ“Š ì¼ë³„ ì…ì¶œê³  ì¶”ì´</div>
                <div class="bar-chart" id="dailyChart"></div>
            </div>
            
            <!-- ìœ í˜•ë³„ ë¹„ìœ¨ -->
            <div class="chart-card">
                <div class="chart-title">ğŸ¥§ ì¶œê³  ìœ í˜•ë³„ ë¹„ìœ¨</div>
                <div class="pie-chart">
                    <svg class="pie-svg" viewBox="0 0 100 100" id="pieChart"></svg>
                    <div class="pie-legend" id="pieLegend"></div>
                </div>
            </div>
            
            <!-- ìµœê·¼ ì´ë ¥ -->
            <div class="chart-card">
                <div class="chart-title">ğŸ• ìµœê·¼ ì…ì¶œê³  ì´ë ¥</div>
                <div class="recent-list" id="recentList"></div>
            </div>
        </div>
    </div>
    <div class="bottom-nav">
        <a href="m_0_0_3.html" class="nav-item"><div class="nav-icon">ğŸ </div>í™ˆ</a>
        <a href="m_3_1_0.html" class="nav-item"><div class="nav-icon">ğŸ“‹</div>ì£¼ë¬¸</a>
        <a href="m_5_1_1.html" class="nav-item"><div class="nav-icon">ğŸ–¨ï¸</div>ì¸ì‡„</a>
        <a href="m_6_1_1.html" class="nav-item"><div class="nav-icon">ğŸ“š</div>ì œë³¸</a>
        <a href="m_7_1_1.html" class="nav-item"><div class="nav-icon">ğŸ“¦</div>ì¶œê³ </a>
    </div>
<script src="./js/mobile-common.js"></script>
<script>
let currentPeriod = 'today';

const dailyData = {
    today: [{ date: 'ì˜¤ëŠ˜', in: 3500, out: 2100 }],
    week: [
        { date: 'ì›”', in: 2500, out: 1800 },
        { date: 'í™”', in: 3200, out: 2400 },
        { date: 'ìˆ˜', in: 2800, out: 2000 },
        { date: 'ëª©', in: 3500, out: 2100 },
        { date: 'ê¸ˆ', in: 2000, out: 1500 }
    ],
    month: [
        { date: '1ì£¼', in: 12000, out: 8500 },
        { date: '2ì£¼', in: 14500, out: 9800 },
        { date: '3ì£¼', in: 11000, out: 7200 },
        { date: '4ì£¼', in: 13500, out: 8900 }
    ],
    quarter: [
        { date: '1ì›”', in: 45000, out: 32000 },
        { date: '2ì›”', in: 52000, out: 38000 },
        { date: '3ì›”', in: 48000, out: 35000 }
    ]
};

const pieData = [
    { label: 'ê³ ê°ì¶œê³ ', value: 65, color: '#ff9800' },
    { label: 'ìƒ˜í”Œì¶œê³ ', value: 20, color: '#4caf50' },
    { label: 'ë‚´ë¶€ì´ë™', value: 10, color: '#2196f3' },
    { label: 'íê¸°', value: 5, color: '#9e9e9e' }
];

const recentData = [
    { type: 'out', name: 'ë¬¸ë²• íƒ„íƒ„ Writing 2', detail: 'Abcì¶œíŒì‚¬ Â· ê³ ê°ì¶œê³ ', qty: '-500ë¶€', time: '10:30' },
    { type: 'in', name: 'Cyan ì‰í¬', detail: 'ì‚¼ì›ì‰í¬ Â· ë°œì£¼ì…ê³ ', qty: '+5kg', time: '09:15' },
    { type: 'out', name: 'ì†Œí˜• ë°•ìŠ¤', detail: 'í¬ì¥ì‹¤ Â· ìƒì‚°ì‚¬ìš©', qty: '-50ê°œ', time: '08:45' },
    { type: 'in', name: 'í•œêµ­ì‚¬ ì—°êµ¬ë°©ë²•ë¡ ', detail: 'ì„œìš¸ëŒ€ì¶œíŒë¶€ Â· ìƒì‚°ì™„ë£Œ', qty: '+500ë¶€', time: 'ì–´ì œ' },
    { type: 'out', name: 'PUR ì ‘ì°©ì œ', detail: 'ì œë³¸ ë¼ì¸ Â· ìƒì‚°ì‚¬ìš©', qty: '-2kg', time: 'ì–´ì œ' }
];

function initPage() {
    renderAll();
}

function setPeriod(period) {
    currentPeriod = period;
    document.querySelectorAll('.period-btn').forEach(b => b.classList.toggle('active', b.dataset.period === period));
    renderAll();
}

function renderAll() {
    renderSummary();
    renderDailyChart();
    renderPieChart();
    renderRecentList();
}

function renderSummary() {
    const data = dailyData[currentPeriod];
    const totalIn = data.reduce((s, d) => s + d.in, 0);
    const totalOut = data.reduce((s, d) => s + d.out, 0);
    document.getElementById('totalIn').textContent = '+' + MobileApp.formatNumber(totalIn);
    document.getElementById('totalOut').textContent = '-' + MobileApp.formatNumber(totalOut);
}

function renderDailyChart() {
    const data = dailyData[currentPeriod];
    const maxVal = Math.max(...data.map(d => Math.max(d.in, d.out)));
    
    document.getElementById('dailyChart').innerHTML = data.map(d => {
        const inWidth = Math.round(d.in / maxVal * 100);
        const outWidth = Math.round(d.out / maxVal * 100);
        return '<div class="bar-row">' +
            '<div class="bar-label">' + d.date + '</div>' +
            '<div class="bar-container">' +
                '<div class="bar-fill in" style="width:' + inWidth + '%">' + MobileApp.formatNumber(d.in) + '</div>' +
            '</div>' +
        '</div>' +
        '<div class="bar-row">' +
            '<div class="bar-label"></div>' +
            '<div class="bar-container">' +
                '<div class="bar-fill out" style="width:' + outWidth + '%">' + MobileApp.formatNumber(d.out) + '</div>' +
            '</div>' +
        '</div>';
    }).join('');
}

function renderPieChart() {
    const total = pieData.reduce((s, d) => s + d.value, 0);
    let cumulative = 0;
    
    let paths = '';
    pieData.forEach(d => {
        const startAngle = cumulative / total * 360;
        cumulative += d.value;
        const endAngle = cumulative / total * 360;
        paths += createPieSlice(50, 50, 45, startAngle, endAngle, d.color);
    });
    
    document.getElementById('pieChart').innerHTML = paths;
    document.getElementById('pieLegend').innerHTML = pieData.map(d => 
        '<div class="legend-item">' +
            '<div class="legend-dot" style="background:' + d.color + '"></div>' +
            '<span>' + d.label + '</span>' +
            '<span style="margin-left:auto;font-weight:bold;">' + d.value + '%</span>' +
        '</div>'
    ).join('');
}

function createPieSlice(cx, cy, r, startAngle, endAngle, color) {
    const start = polarToCartesian(cx, cy, r, endAngle);
    const end = polarToCartesian(cx, cy, r, startAngle);
    const largeArcFlag = endAngle - startAngle <= 180 ? 0 : 1;
    return '<path d="M ' + cx + ' ' + cy + ' L ' + start.x + ' ' + start.y + ' A ' + r + ' ' + r + ' 0 ' + largeArcFlag + ' 0 ' + end.x + ' ' + end.y + ' Z" fill="' + color + '"/>';
}

function polarToCartesian(cx, cy, r, angle) {
    const rad = (angle - 90) * Math.PI / 180;
    return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
}

function renderRecentList() {
    // ì¬ê³ ì¡°ì • ì´ë ¥ ê°€ì ¸ì˜¤ê¸°
    var adjustmentHistory = [];
    try {
        adjustmentHistory = JSON.parse(localStorage.getItem('stockAdjustmentHistory') || '[]');
    } catch(e) {}
    
    // ì¬ê³ ì¡°ì • ì´ë ¥ì„ ìµœê·¼ ì´ë ¥ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    var adjustmentItems = adjustmentHistory.map(function(adj) {
        var qtyText = adj.adjustQty >= 0 ? '+' + adj.adjustQty : '' + adj.adjustQty;
        return {
            type: 'adjust',
            name: adj.name,
            detail: adj.reason + ' Â· ì¬ê³ ì¡°ì •',
            qty: qtyText + adj.unit,
            time: adj.time || 'ë°©ê¸ˆ',
            timestamp: adj.timestamp,
            isAdjust: true
        };
    });
    
    // ê¸°ì¡´ ë°ì´í„°ì— timestamp ì¶”ê°€
    var baseItems = recentData.map(function(d) {
        return Object.assign({}, d, { isAdjust: false });
    });
    
    // ì¬ê³ ì¡°ì • ì´ë ¥ì´ ìˆìœ¼ë©´ ìµœìƒë‹¨ì— í‘œì‹œ
    var allData = adjustmentItems.concat(baseItems);
    
    document.getElementById('recentList').innerHTML = allData.map(function(d) {
        var iconClass = d.isAdjust ? 'adjust' : d.type;
        var icon = d.isAdjust ? 'âš–ï¸' : (d.type === 'in' ? 'ğŸ“¥' : 'ğŸ“¤');
        var qtyClass = d.isAdjust ? 'adjust' : d.type;
        
        return '<div class="recent-item">' +
            '<div class="recent-icon ' + iconClass + '">' + icon + '</div>' +
            '<div class="recent-info">' +
                '<div class="recent-title">' + d.name + '</div>' +
                '<div class="recent-detail">' + d.detail + '</div>' +
            '</div>' +
            '<div>' +
                '<div class="recent-qty ' + qtyClass + '">' + d.qty + '</div>' +
                '<div style="font-size:11px;color:#888;text-align:right;">' + d.time + '</div>' +
            '</div>' +
        '</div>';
    }).join('');
}

document.addEventListener('DOMContentLoaded', initPage);
</script>
</body>
</html>
