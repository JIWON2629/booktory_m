<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¬ê³ ì‹¤ì‚¬ - KSI OSP</title>
    <link rel="stylesheet" href="./css/mobile-common.css">
    <style>
        body { background: #f5f5f5; padding-bottom: 140px; }
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; z-index: 100; background: white; }
        .sub-header { position: relative; background: white; padding: 10px 15px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee; }
        .sub-header-title { font-size: 17px; font-weight: bold; flex: 1; }
        .btn-back { background: none; border: none; font-size: 20px; color: #333; padding: 5px; }
        .btn-sm { padding: 6px 12px; border: 1px solid #ddd; background: white; border-radius: 6px; font-size: 12px; color: #666; }
        .tabs { display: flex; background: white; border-bottom: 1px solid #eee; }
        .tab-btn { flex: 1; padding: 12px 8px; border: none; background: none; font-size: 14px; color: #666; font-weight: 500; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: #4caf50; border-bottom-color: #4caf50; }
        .search-section { background: white; padding: 12px 15px; border-bottom: 1px solid #eee; }
        .search-input { width: 100%; padding: 12px; border: 2px solid #4caf50; border-radius: 8px; font-size: 15px; box-sizing: border-box; }
        .search-input:focus { outline: none; border-color: #2e7d32; }
        .main-content { margin-top: 160px; padding: 15px; }
        .check-item { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; }
        .check-item.highlight { border: 2px solid #4caf50; background: #e8f5e9; }
        .check-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .check-item-name { font-weight: bold; font-size: 15px; }
        .check-item-code { font-size: 13px; color: #888; margin-top: 2px; }
        .check-item-row { display: flex; gap: 12px; align-items: center; }
        .check-item-col { flex: 1; text-align: center; }
        .check-label { font-size: 13px; color: #888; margin-bottom: 4px; }
        .check-value { font-size: 20px; font-weight: bold; }
        .check-value.system { color: #1a73e8; }
        .check-value.actual { color: #4caf50; }
        .check-value.diff { color: #f44336; }
        .check-value.diff.plus { color: #4caf50; }
        .check-input { width: 100%; padding: 12px; border: 2px solid #4caf50; border-radius: 8px; font-size: 18px; text-align: center; font-weight: bold; box-sizing: border-box; }
        .check-status { padding: 5px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .check-status.pending { background: #f5f5f5; color: #666; }
        .check-status.done { background: #e8f5e9; color: #2e7d32; }
        .check-status.diff { background: #ffebee; color: #c62828; }
        .progress-bar { height: 10px; background: #e0e0e0; border-radius: 5px; margin-bottom: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: #4caf50; transition: width 0.3s; }
        .summary-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; }
        .bottom-actions { position: fixed; bottom: 56px; left: 0; right: 0; padding: 12px 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; z-index: 90; }
        .bottom-actions .btn { flex: 1; padding: 13px; font-size: 14px; border-radius: 6px; border: 1px solid #ddd; background: white; }
        .bottom-actions .btn-primary { background: #4caf50; color: white; border-color: #4caf50; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; border-top: 1px solid #eee; z-index: 100; height: 56px; }
        .nav-item { flex: 1; padding: 8px 5px; text-align: center; font-size: 11px; color: #666; text-decoration: none; }
        .nav-icon { font-size: 20px; margin-bottom: 2px; }
        .toast { position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 8px; z-index: 400; opacity: 0; transition: opacity 0.3s; font-size: 14px; }
    </style>
</head>
<body>
    <div class="fixed-header">
        <div class="sub-header">
            <button class="btn-back" onclick="location.href='m_9_1_0.html'">â†</button>
            <div class="sub-header-title">ğŸ“Š ì¬ê³ ì‹¤ì‚¬</div>
            <button class="btn-sm" onclick="resetCheck()">ì´ˆê¸°í™”</button>
        </div>
        <div class="tabs">
            <button class="tab-btn active" data-tab="product" onclick="switchTab('product')">ğŸ“¦ ì™„ì œí’ˆ</button>
            <button class="tab-btn" data-tab="supply" onclick="switchTab('supply')">ğŸ”§ ë¶€ìì¬</button>
            <button class="tab-btn" data-tab="packaging" onclick="switchTab('packaging')">ğŸ“¦ í¬ì¥ì¬</button>
        </div>
        <div class="search-section">
            <div style="display:flex;gap:8px;">
                <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” ì œì‘ë²ˆí˜¸, ISBN, ë°”ì½”ë“œ, í’ˆëª©ëª… ê²€ìƒ‰" onkeypress="handleSearchKeypress(event)" style="flex:1;">
                <button onclick="doSearch()" style="padding:12px 16px;background:#4caf50;color:white;border:none;border-radius:8px;font-size:14px;font-weight:bold;white-space:nowrap;">ê²€ìƒ‰</button>
            </div>
        </div>
    </div>
    <div class="main-content">
        <div class="summary-card">
            <div style="font-weight:bold; font-size:15px; margin-bottom:12px;">ğŸ“‹ ì‹¤ì‚¬ ì§„í–‰ë¥ </div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
            <div class="summary-row"><span>ì „ì²´ í’ˆëª©</span><span id="totalCount">0ê±´</span></div>
            <div class="summary-row"><span>ì™„ë£Œ</span><span id="doneCount" style="color:#4caf50">0ê±´</span></div>
            <div class="summary-row"><span>ì°¨ì´ ë°œìƒ</span><span id="diffCount" style="color:#f44336">0ê±´</span></div>
        </div>
        <div id="checkList"></div>
    </div>
    <div class="bottom-actions">
        <button class="btn" onclick="saveDraft()">ì„ì‹œì €ì¥</button>
        <button class="btn btn-primary" onclick="submitCheck()">ğŸ“Š ì‹¤ì‚¬ì™„ë£Œ</button>
    </div>
    <div class="bottom-nav">
        <a href="m_0_0_3.html" class="nav-item"><div class="nav-icon">ğŸ </div>í™ˆ</a>
        <a href="m_3_1_0.html" class="nav-item"><div class="nav-icon">ğŸ“‹</div>ì£¼ë¬¸</a>
        <a href="m_5_1_1.html" class="nav-item"><div class="nav-icon">ğŸ–¨ï¸</div>ì¸ì‡„</a>
        <a href="m_6_1_1.html" class="nav-item"><div class="nav-icon">ğŸ“š</div>ì œë³¸</a>
        <a href="m_7_1_1.html" class="nav-item"><div class="nav-icon">ğŸ“¦</div>ì¶œê³ </a>
    </div>
<script>
let currentTab = 'product';
let checkData = { product: [], supply: [], packaging: [] };
let highlightedItemId = null;

const productItems = [
    { id: '28646', barcode: '9788955123456', isbn: '978-89-5512-345-6', name: 'ë¬¸ë²• íƒ„íƒ„ Writing 2', systemQty: 800, unit: 'ë¶€' },
    { id: '28645', barcode: '9788955123457', isbn: '978-89-5512-345-7', name: 'í•œêµ­ì‚¬ ì—°êµ¬ë°©ë²•ë¡ ', systemQty: 500, unit: 'ë¶€' },
    { id: '28644', barcode: '9788955123458', isbn: '978-89-5512-345-8', name: 'ì„ìƒì˜í•™ í•¸ë“œë¶', systemQty: 1000, unit: 'ë¶€' },
    { id: '28643', barcode: '9788955123459', isbn: '978-89-5512-345-9', name: 'AI í”„ë¡œê·¸ë˜ë° ì…ë¬¸', systemQty: 1200, unit: 'ë¶€' },
    { id: '28642', barcode: '9788955123460', isbn: '978-89-5512-346-0', name: 'ìˆ˜ëŠ¥íŠ¹ê°• êµ­ì–´', systemQty: 3000, unit: 'ë¶€' },
    { id: '28641', barcode: '9788955123461', isbn: '978-89-5512-346-1', name: 'ë¯¼ë²•ì´ë¡  ê°œì •íŒ', systemQty: 1500, unit: 'ë¶€' },
    { id: '28640', barcode: '9788955123462', isbn: '978-89-5512-346-2', name: '2025 êµìœ¡ë°±ì„œ', systemQty: 2500, unit: 'ë¶€' }
];
const supplyItems = [
    { id: 'INK-C', barcode: '8801234567890', name: 'Cyan ì‰í¬', systemQty: 12, unit: 'kg' },
    { id: 'INK-M', barcode: '8801234567891', name: 'Magenta ì‰í¬', systemQty: 2, unit: 'kg' },
    { id: 'INK-Y', barcode: '8801234567892', name: 'Yellow ì‰í¬', systemQty: 15, unit: 'kg' },
    { id: 'INK-K', barcode: '8801234567893', name: 'Black ì‰í¬', systemQty: 20, unit: 'kg' },
    { id: 'ADH-PUR', barcode: '8801234567894', name: 'PUR ì ‘ì°©ì œ', systemQty: 8, unit: 'kg' },
    { id: 'ADH-HM', barcode: '8801234567895', name: 'í•«ë©œíŠ¸ ì ‘ì°©ì œ', systemQty: 25, unit: 'kg' }
];
const packagingItems = [
    { id: 'BOX-S', barcode: '8809876543210', name: 'ì†Œí˜• ë°•ìŠ¤', systemQty: 250, unit: 'ê°œ' },
    { id: 'BOX-M', barcode: '8809876543211', name: 'ì¤‘í˜• ë°•ìŠ¤', systemQty: 45, unit: 'ê°œ' },
    { id: 'BOX-L', barcode: '8809876543212', name: 'ëŒ€í˜• ë°•ìŠ¤', systemQty: 100, unit: 'ê°œ' },
    { id: 'TAPE-B', barcode: '8809876543213', name: 'í¬ì¥í…Œì´í”„(ê°ˆìƒ‰)', systemQty: 50, unit: 'ë¡¤' },
    { id: 'WRAP-S', barcode: '8809876543214', name: 'ìŠ¤íŠ¸ë ˆì¹˜í•„ë¦„', systemQty: 30, unit: 'ë¡¤' }
];

function initPage() {
    checkData.product = productItems.map(function(i) { return Object.assign({}, i, { actualQty: null, status: 'pending' }); });
    checkData.supply = supplyItems.map(function(i) { return Object.assign({}, i, { actualQty: null, status: 'pending' }); });
    checkData.packaging = packagingItems.map(function(i) { return Object.assign({}, i, { actualQty: null, status: 'pending' }); });
    renderAll();
}

function switchTab(tab) {
    currentTab = tab;
    highlightedItemId = null;
    document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.tab === tab); });
    renderList();
}

function renderAll() { renderList(); renderSummary(); }

function handleSearchKeypress(e) {
    if (e.key === 'Enter' || e.keyCode === 13) {
        e.preventDefault();
        doSearch();
    }
}

function doSearch() {
    var keyword = document.getElementById('searchInput').value.trim().toLowerCase();
    if (!keyword) {
        highlightedItemId = null;
        renderList();
        return;
    }
    
    var allItems = checkData.product.concat(checkData.supply).concat(checkData.packaging);
    var found = null;
    for (var i = 0; i < allItems.length; i++) {
        var item = allItems[i];
        if (item.id.toLowerCase().indexOf(keyword) !== -1 ||
            item.name.toLowerCase().indexOf(keyword) !== -1 ||
            (item.barcode && item.barcode.indexOf(keyword) !== -1) ||
            (item.isbn && item.isbn.toLowerCase().indexOf(keyword) !== -1)) {
            found = item;
            break;
        }
    }
    
    if (found) {
        var foundInProduct = false, foundInSupply = false;
        for (var j = 0; j < checkData.product.length; j++) {
            if (checkData.product[j].id === found.id) { foundInProduct = true; break; }
        }
        if (!foundInProduct) {
            for (var k = 0; k < checkData.supply.length; k++) {
                if (checkData.supply[k].id === found.id) { foundInSupply = true; break; }
            }
        }
        
        if (foundInProduct) {
            currentTab = 'product';
        } else if (foundInSupply) {
            currentTab = 'supply';
        } else {
            currentTab = 'packaging';
        }
        document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.tab === currentTab); });
        
        highlightedItemId = found.id;
        renderList();
        
        setTimeout(function() {
            var input = document.getElementById('input-' + found.id);
            if (input) {
                input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(function() {
                    input.focus();
                    input.select();
                }, 300);
            }
        }, 100);
    } else {
        highlightedItemId = null;
        renderList();
        showToast('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤');
    }
}

function renderList() {
    var items = checkData[currentTab];
    var html = '';
    for (var idx = 0; idx < items.length; idx++) {
        var item = items[idx];
        var diff = item.actualQty !== null ? item.actualQty - item.systemQty : null;
        var diffClass = diff === null ? '' : (diff === 0 ? '' : (diff > 0 ? 'plus' : ''));
        var diffText = diff === null ? '-' : (diff >= 0 ? '+' + diff : diff);
        var statusClass = item.status;
        var statusText = item.status === 'pending' ? 'ë¯¸ì™„ë£Œ' : (item.status === 'done' ? 'ì™„ë£Œ' : 'ì°¨ì´');
        var isHighlighted = item.id === highlightedItemId;
        
        html += '<div class="check-item' + (isHighlighted ? ' highlight' : '') + '">' +
            '<div class="check-item-header">' +
                '<div><div class="check-item-name">' + item.name + '</div><div class="check-item-code">' + item.id + (item.barcode ? ' Â· ' + item.barcode : '') + '</div></div>' +
                '<span class="check-status ' + statusClass + '">' + statusText + '</span>' +
            '</div>' +
            '<div class="check-item-row">' +
                '<div class="check-item-col"><div class="check-label">ì‹œìŠ¤í…œ</div><div class="check-value system">' + item.systemQty.toLocaleString() + '</div></div>' +
                '<div class="check-item-col"><div class="check-label">ì‹¤ìˆ˜ëŸ‰</div><input type="number" class="check-input" id="input-' + item.id + '" value="' + (item.actualQty !== null ? item.actualQty : '') + '" placeholder="ì…ë ¥" onchange="updateActual(\'' + currentTab + '\',' + idx + ',this.value)"></div>' +
                '<div class="check-item-col"><div class="check-label">ì°¨ì´</div><div class="check-value diff ' + diffClass + '">' + diffText + '</div></div>' +
            '</div>' +
        '</div>';
    }
    document.getElementById('checkList').innerHTML = html;
}

function updateActual(tab, idx, val) {
    var qty = val === '' ? null : parseInt(val);
    checkData[tab][idx].actualQty = qty;
    if (qty === null) {
        checkData[tab][idx].status = 'pending';
    } else if (qty === checkData[tab][idx].systemQty) {
        checkData[tab][idx].status = 'done';
    } else {
        checkData[tab][idx].status = 'diff';
    }
    renderAll();
    
    // ì‹¤ìˆ˜ëŸ‰ ì…ë ¥ í›„ ê²€ìƒ‰ì°½ìœ¼ë¡œ ì»¤ì„œ ì´ë™
    if (qty !== null) {
        setTimeout(function() {
            var searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            searchInput.focus();
        }, 100);
    }
}

function renderSummary() {
    var all = checkData.product.concat(checkData.supply).concat(checkData.packaging);
    var total = all.length;
    var done = 0, diff = 0;
    for (var i = 0; i < all.length; i++) {
        if (all[i].status !== 'pending') done++;
        if (all[i].status === 'diff') diff++;
    }
    
    document.getElementById('totalCount').textContent = total + 'ê±´';
    document.getElementById('doneCount').textContent = done + 'ê±´';
    document.getElementById('diffCount').textContent = diff + 'ê±´';
    document.getElementById('progressFill').style.width = (total > 0 ? Math.round(done / total * 100) : 0) + '%';
}

function resetCheck() {
    if (!confirm('ì‹¤ì‚¬ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    localStorage.removeItem('stockCheckResult');
    initPage();
    showToast('ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function saveDraft() {
    localStorage.setItem('stockCheckDraft', JSON.stringify(checkData));
    showToast('ì„ì‹œì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function submitCheck() {
    var all = checkData.product.concat(checkData.supply).concat(checkData.packaging);
    var pending = 0;
    var diffItems = [];
    
    for (var i = 0; i < all.length; i++) {
        if (all[i].status === 'pending') pending++;
        if (all[i].status === 'diff') {
            diffItems.push({
                id: all[i].id,
                name: all[i].name,
                barcode: all[i].barcode || '',
                systemQty: all[i].systemQty,
                actualQty: all[i].actualQty,
                unit: all[i].unit,
                type: getItemType(all[i].id)
            });
        }
    }
    
    if (pending > 0) {
        if (!confirm(pending + 'ê±´ì´ ë¯¸ì™„ë£Œì…ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    }
    
    // ì‹¤ì‚¬ ê²°ê³¼ ì €ì¥ (ì°¨ì´ ë°œìƒ í’ˆëª©)
    var result = {
        date: new Date().toISOString().split('T')[0],
        timestamp: new Date().toISOString(),
        diffCount: diffItems.length,
        items: diffItems
    };
    
    localStorage.setItem('stockCheckResult', JSON.stringify(result));
    localStorage.removeItem('stockCheckDraft');
    
    if (diffItems.length > 0) {
        showToast('ì‹¤ì‚¬ ì™„ë£Œ! ì°¨ì´ ' + diffItems.length + 'ê±´ ë°œìƒ');
        setTimeout(function() {
            if (confirm('ì°¨ì´ ë°œìƒ í’ˆëª©ì´ ìˆìŠµë‹ˆë‹¤. ì¬ê³ ì¡°ì • í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                location.href = 'm_9_8_0.html';
            } else {
                location.href = 'm_9_1_0.html';
            }
        }, 500);
    } else {
        showToast('ì‹¤ì‚¬ ì™„ë£Œ! ëª¨ë“  ì¬ê³ ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.');
        setTimeout(function() {
            location.href = 'm_9_1_0.html';
        }, 1500);
    }
}

function getItemType(id) {
    for (var i = 0; i < checkData.product.length; i++) {
        if (checkData.product[i].id === id) return 'product';
    }
    for (var i = 0; i < checkData.supply.length; i++) {
        if (checkData.supply[i].id === id) return 'supply';
    }
    return 'packaging';
}

function showToast(msg) {
    var t = document.querySelector('.toast');
    if (!t) {
        t = document.createElement('div');
        t.className = 'toast';
        document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.opacity = '1';
    setTimeout(function() { t.style.opacity = '0'; }, 2000);
}

document.addEventListener('DOMContentLoaded', initPage);
</script>
</body>
</html>
